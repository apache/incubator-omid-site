<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7 at 2016-07-01 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20160701" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Apache Omid &#x2013; Omid Architecture and Component Description</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarEnabled">
          
                        
                    
                

    <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
                                  <div class="container" style="width: 100%;"><div class="nav-collapse">
            
                
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Home <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="index.html"  title="Overview">Overview</a>
</li>
                  
                      <li>      <a href="license.html"  title="License">License</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Download <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="https://github.com/yahoo/omid"  title="Omid Sources">Omid Sources</a>
</li>
                  
                      <li>      <a href="https://bintray.com/yahoo/maven/omid/_latestVersion"  title="Bintray Repository">Bintray Repository</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide & API <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="quickstart.html"  title="Quickstart">Quickstart</a>
</li>
                  
                      <li>      <a href="basic-examples.html"  title="API and Code Examples">API and Code Examples</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Technical Docs <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="basic-concepts.html"  title="Basic Concepts">Basic Concepts</a>
</li>
                  
                      <li>      <a href="omid-components.html"  title="Omid Components">Omid Components</a>
</li>
                  
                      <li>      <a href="basic-algorithm.html"  title="Basic Algorithm">Basic Algorithm</a>
</li>
                  
                      <li>      <a href="client-failure-management.html"  title="Management of Client Failures">Management of Client Failures</a>
</li>
                  
                      <li>      <a href="http://yahoohadoop.tumblr.com/tagged/HBase"  title="Blog Entries">Blog Entries</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contribute <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="https://git-wip-us.apache.org/repos/asf/incubator-omid.git"  title="Source Code">Source Code</a>
</li>
                  
                      <li>      <a href="https://issues.apache.org/jira/browse/Omid"  title="JIRA">JIRA</a>
</li>
                  
                      <li>      <a href="mailing-lists.html"  title="Mailing Lists">Mailing Lists</a>
</li>
                  
                      <li>      <a href="coding-guide-and-style.html"  title="Coding Guide and Style">Coding Guide and Style</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Reports <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="dependency-convergence.html"  title="Dependency Convergence">Dependency Convergence</a>
</li>
                                  <li>      <a href="dependency-info.html"  title="Dependency Information">Dependency Information</a>
</li>
                                  <li>      <a href="dependency-management.html"  title="Dependency Management">Dependency Management</a>
</li>
                                  <li>      <a href="distribution-management.html"  title="Distribution Management">Distribution Management</a>
</li>
                                  <li>      <a href="index.html"  title="About">About</a>
</li>
                                  <li>      <a href="license.html"  title="Licenses">Licenses</a>
</li>
                                  <li>      <a href="mail-lists.html"  title="Mailing Lists">Mailing Lists</a>
</li>
                                  <li>      <a href="modules.html"  title="Project Modules">Project Modules</a>
</li>
                                  <li>      <a href="plugin-management.html"  title="Plugin Management">Plugin Management</a>
</li>
                                  <li>      <a href="plugins.html"  title="Plugins">Plugins</a>
</li>
                                  <li>      <a href="team-list.html"  title="Team">Team</a>
</li>
                                  <li>      <a href="source-repository.html"  title="Source Code Management">Source Code Management</a>
</li>
                                  <li>      <a href="project-summary.html"  title="Summary">Summary</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="xref/index.html"  title="Source Xref">Source Xref</a>
</li>
                                  <li>      <a href="xref-test/index.html"  title="Test Source Xref">Test Source Xref</a>
</li>
                                  <li>      <a href="checkstyle-aggregate.html"  title="Checkstyle">Checkstyle</a>
</li>
                                  <li>      <a href="cpd.html"  title="CPD">CPD</a>
</li>
                                  <li>      <a href="pmd.html"  title="PMD">PMD</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                  </ul>
          
                      <form id="search-form" action="https://www.google.com/search" method="get"  class="navbar-search pull-right" >
    
  <input value="omid.incubator.apache.org" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="https://cse.google.com/brand?form=search-form"></script>
          
                                                    
        
        
        <ul class="nav pull-right"><li>
    
    <a href="https://twitter.com/apacheomid" class="twitter-follow-button" data-show-count="true" data-align="right" data-size="large" data-show-screen-name="true" data-lang="en">Follow apacheomid</a>
    <script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

        </li></ul>
                              
                   
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="./" id="bannerLeft">
                                                                                                <img src="images/omid-logo.png"  alt="Omid" width="200"/>
                </a>
                      </div>
        <div class="pull-right">                  <a href="http://incubator.apache.org/" id="bannerRight">
                                                                                        <img src="http://incubator.apache.org/images/egg-logo2.png"  alt="Apache Incubator" width="200"/>
                </a>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="projectVersion">Version: 0.8.2.0
                    </li>
              
              
                  <li id="publishDate" class="pull-right">Last Published: 2016-07-01</li>
            
                            </ul>
      </div>

      
                
        <div id="bodyColumn" >
                                  
            <h1>Omid Architecture and Component Description</h1>
<p>The following figure depicts the current Omid architecture presented in the section presenting Omid:</p>
<p><img src="images/architecture.png" alt="Omid&rsquo;s architecture" /></p>
<p>The following sections describe more in deep the most important components and elements in the Omid architecture.</p>
<div class="section">
<h2><a name="Transactional_Clients_TCs"></a>Transactional Clients (TCs)</h2>
<p><b>Transactional Clients (TCs)</b> are the entry point to user applications using transactions with Omid. They allow applications to <i>demarcate transactional boundaries</i> and <i>read/write transactionally from/to the data source</i>, HBase in this case.</p>
<p>There are two main interfaces/classes that compose the Transactional Client:</p>

<ol style="list-style-type: decimal">
  
<li>The Transaction Manager interface (represented by the <tt>TransactionManager</tt> interface in the current implementation): Allows user applications to demarcate transactional contexts, providing methods to begin(), commit(), rollback() and markRollbackOnly() transactions.</li>
  
<li>The Data Operation interface (represented by the <tt>TTable</tt> class in the HBase implementation): Allows user applications to trigger transactional operations to the datasource. For example in the HBase, put, get and scan operations.</li>
</ol>
<p>Examples about how to add transactions using these interfaces are described in the <a href="./Basic-Examples.html">Basic Examples</a> section.</p></div>
<div class="section">
<h2><a name="Timestamp_Oracle_TO"></a>Timestamp Oracle (TO)</h2>
<p>The single responsibility of the Timestamp Oracle is to manage transaction timestamps. Transaction timestamps serve as a logical clock and are used mainly to preserve the time-related guarantees required for Snapshot Isolation.</p>
<p>The TO allocates and delivers transaction timestamps when required by the TSO. To achieve this task, it maintains a monotonically increasing counter. Transaction timestamps are allocated when a transaction begins and right after a transaction willing to commit has passed the writeset validation. The start timestamp is also used as transaction identifier. </p>
<p>In order to guarantee that all timestamps are unique, the TO has to persist a value after every N timestamp allocations. This value will be used for recovering the TSO in case of crashes. The value persisted is the current timestamp value plus N, N being a congurable property. From that point on, the TO is then free to safely allocate timestamps up to that value.</p>
<p>In the current implementation, the maximum allocated timestamp value can be persisted/stored in:</p>

<ul>
  
<li>ZooKeeper</li>
  
<li>In its own HBase table</li>
</ul></div>
<div class="section">
<h2><a name="The_Server_Oracle_TSO"></a>The Server Oracle (TSO)</h2>
<p>The TSO is the core component in Omid. There is a single instance of the TSO (Although a high availability protocol is currently a WIP). Its unique responsibility is to resolve conflicts between concurrent transactions. The TSO must maintain the last allocated timestamp, the so-called low watermark and a conflict map for detecting conflicts in the writesets of concurrent transactions. It also delegates the update and persistence of a list of committed transactions to the commit table component (see Figure). Aborted and uncommitted transactions are not tracked. Maintaining the TSO state to the minimum allows us to avoid contention in many cases and provides fast recovery upon crashes.</p>
<p>As mentioned before, conflict resolution for transactions is the primary function of the TSO. To achieve this task, it uses a large map structure of (cellId -&gt; lastCommittedTransaction) pairs called the conflict map. When the client commits a transaction, it sends the cell ids of the cells being committed, i.e. its writeset, to the TSO, which checks possible conflicts when other transactions that were concurrent using the conflict map. If no conflicts are found, a commit timestamp is allocated and the lastCommittedTransaction for each cell id in the transaction is updated to this timestamp.</p>
<p>Confict detection is implemented by comparing the hash of the cell ids in the writeset, not the actual cell id value. As the conflict map does not have a one to one mapping with each cell in cell in the database, this means that there&#x2019;s a possibility of false aborts in the system. The probability of false aborts is a variant of the <a class="externalLink" href="http://en.wikipedia.org/wiki/Birthday_problem">birthday problem</a> and basically translates into the fact that long-running transactions are more likely to have false aborts.</p>
<p>The low watermark is only updated when a value is replaced in the conflict map. The current implementation of the conflict map uses an open addressing type mechanism, using linear probing with a limit to the amount of probing. When a cell is checked it is hashed to a location in the map. If the location occupied, the location is checked and so on. If the cell finds an entry which matches its cell id, it replaces it. Otherwise, if the process gets to the end of the probe without finding an empty location, it replaces the cell with the oldest commit timestamp. The oldest commit timestamp then becomes the low watermark in the TSO. This must occur to ensure that conflicts are not missed, as it would be possible for a row to not find a potential conflict that had been overridden if the low watermark was not updated.</p>
<div class="section">
<h3><a name="Processing_Commit_Requests"></a>Processing Commit Requests</h3>
<p>When processing the commit request for a transaction, the TSO first checks if the start timestamp is greater the low watermark and if so, if there was another concurrent transaction whose writeset overlapped and whose commit timestamp is greater the start timestamp of the requesting transaction. If no conflicts are found, a commit timestamp is generated for the request transaction which is added to the conflict map for the writeset, the commit is added to the commit table and finally the client is notified about the successful commit. Otherwise, the commit fails and the client is notied on the rollback of the transaction.</p></div></div>
<div class="section">
<h2><a name="Commit_Table_CT"></a>Commit Table (CT)</h2>
<p>It contains a transient mapping from start timestamp to commit timestamp for recently committed transactions. The commit table is stored on a different set of nodes to the TSO. When a transaction is committed on the TSO it must be stored in the commit table before a response is sent to the client. As the key value mapping in the commit table are completely independent of each other, the table can be trivially scaled by sharding the values over multiple nodes.</p>
<p>The commit table provides two services to the Transactional Client. Firstly, it is used to check if a transaction has been committed or not. The client should not need to consult the commit table in the common case as the status of a read cell should be available from its shadow cell (see below).</p>
<p>The other service provided by the commit table is that transaction clients can delete commits from it. This only occurs once the writing client has updated shadow cells for each of the cells written in the transaction. We call this commit or transaction completion. It is possible that a client will crash between a transaction being committed and being completed. In this case, the transaction will stay in the commit table forever. However as the commit table is not stored in memory and the window of opportunity for such a crash is quite low, we don&#x2019;t expect this to be a problem.</p></div>
<div class="section">
<h2><a name="Shadow_Cells_SCs"></a>Shadow Cells (SCs)</h2>
<p>Shadow cells contain a mapping from start timestamp to commit timestamp of the last committed transaction that modified the cell. Upon receiving a commit timestamp after a successful transaction commit, the Transactional Client adds/updates these special cells to each modified cell in the writeset of the committed transaction. The purpose of this, is that Transactional Clients can then query the corresponding shadow cell when they read each cell to check if the data they find in the cell has been committed or not and whether it is within the snapshot of the reading transaction.</p></div>
                  </div>
          </div>

    <hr/>

    <footer>
            <div class="container">
                      <div class="row">
                                      <p >Copyright &copy;                    2011&#x2013;2016
                        <a href="http://www.apache.org">Apache Software Foundation</a>.
            All rights reserved.    
      </p>
                </div>

                <p id="poweredBy" class="pull-right">
                                                                                                                <a href="http://maven.apache.org/" title="Maven" class="builtBy">
        <img class="builtBy"  alt="Maven" src="http://maven.apache.org/images/logos/maven-feather.png"    />
      </a>
                  </p>
        
                </div>
    </footer>
        </body>
</html>
